## Technical Documentation
10264 - Drawing with Assistant
May 2018
* * *
## **Bill of Materials**
Assembly Time: 8 - 10 Hours

Approximate Cost: $287.83

<table>
  <tr>
    <td>Model Name</td>
    <td>Link</td>
    <td>QTY</td>
    <td>Package Cost</td>
    <td>QTY per Package</td>
    <td>Total</td>
  </tr>
  <tr>
    <td>Motor Mount</td>
    <td>https://www.inventables.com/technologies/motor-mount-nema-17-or-23</td>
    <td>3</td>
    <td>9.99</td>
    <td>1</td>
    <td>$29.97</td>
  </tr>
  <tr>
    <td>V-Wheel</td>
    <td>https://www.inventables.com/technologies/dual-bearing-v-wheel-kit</td>
    <td>8</td>
    <td>5.49</td>
    <td>1</td>
    <td>$43.92</td>
  </tr>
  <tr>
    <td>Idler Pulley</td>
    <td>https://www.inventables.com/technologies/smooth-idler-wheel-kit</td>
    <td>4</td>
    <td>5.99</td>
    <td>1</td>
    <td>$23.96</td>
  </tr>
  <tr>
    <td>Eccentric Spacer</td>
    <td>https://www.inventables.com/technologies/eccentric-spacer</td>
    <td>4</td>
    <td>2</td>
    <td>1</td>
    <td>$8.00</td>
  </tr>
  <tr>
    <td>Aluminum GT2 Pulley</td>
    <td>https://www.inventables.com/technologies/aluminum-gt2-pulley</td>
    <td>3</td>
    <td>6.99</td>
    <td>1</td>
    <td>$20.97</td>
  </tr>
  <tr>
    <td>GT2 Belting - Open Ended</td>
    <td>https://www.inventables.com/technologies/gt2-belting-open-ended</td>
    <td>1</td>
    <td>20</td>
    <td>1</td>
    <td>$20.00</td>
  </tr>
  <tr>
    <td>MakerSlide</td>
    <td>https://www.inventables.com/technologies/makerslide</td>
    <td>1</td>
    <td>23.99</td>
    <td>1</td>
    <td>$23.99</td>
  </tr>
  <tr>
    <td>Low-Profile Socket Head Screw</td>
    <td>https://www.mcmaster.com/#93070a120/=1cqkepz</td>
    <td>1</td>
    <td>5.55</td>
    <td>25</td>
    <td>$5.55</td>
  </tr>
  <tr>
    <td>Low-Profile Socket Head Screws</td>
    <td>https://www.mcmaster.com/#92855a519/=1cqkfls</td>
    <td>2</td>
    <td>8.5</td>
    <td>25</td>
    <td>$8.50</td>
  </tr>
  <tr>
    <td>Threaded Hex Standoff</td>
    <td>https://www.mcmaster.com/#95947a054/=1cqkha0</td>
    <td>6</td>
    <td>0.85</td>
    <td>1</td>
    <td>$5.10</td>
  </tr>
  <tr>
    <td>Aluminum Unthreaded Spacer</td>
    <td>https://www.mcmaster.com/#94669a031/=1cqki86</td>
    <td>25</td>
    <td>1.28</td>
    <td>1</td>
    <td>$32.00</td>
  </tr>
  <tr>
    <td>Low-Profile Socket Head Screws</td>
    <td>https://www.mcmaster.com/#92855a537/=1cqlaiu</td>
    <td>1</td>
    <td>8.23</td>
    <td>10</td>
    <td>$8.23</td>
  </tr>
  <tr>
    <td>Aluminum Unthreaded Spacer</td>
    <td>https://www.mcmaster.com/#94669a326/=1cqlft1</td>
    <td>1</td>
    <td>1.78</td>
    <td>1</td>
    <td>$1.78</td>
  </tr>
  <tr>
    <td>Low-Profile Socket Head Screws</td>
    <td>https://www.mcmaster.com/#92855a310/=1cqlj7z</td>
    <td>1</td>
    <td>2.63</td>
    <td>25</td>
    <td>$2.63</td>
  </tr>
  <tr>
    <td>Steel Nylon-Insert Locknut</td>
    <td>https://www.mcmaster.com/#94645a102/=1cqllqu</td>
    <td>1</td>
    <td>12.56</td>
    <td>100</td>
    <td>$12.56</td>
  </tr>
  <tr>
    <td>USB Audio Card</td>
    <td>https://www.amazon.com/UGREEN-External-Headphone-Microphone-Desktops/dp/B01N905VOY/</td>
    <td>1</td>
    <td>8.69</td>
    <td>1</td>
    <td>$8.69</td>
  </tr>
  <tr>
    <td>3.5mm Microphone</td>
    <td>https://www.amazon.com/Conference-Microphone-FOKEY-Computers-Omnidirectional/dp/B075RWPHCQ/</td>
    <td>1</td>
    <td>19.99</td>
    <td>1</td>
    <td>$19.99</td>
  </tr>
  <tr>
    <td>Speakers</td>
    <td>https://www.amazon.com/Earise-AL-101-Computer-Speakers-Powered/dp/B00CXLCMGY/</td>
    <td>1</td>
    <td>11.99</td>
    <td>1</td>
    <td>$11.99</td>
  </tr>
</table>

## Assembly Instructions

### Gather your materials
* 3d print the assets in this directory.
* Laser cut this file out of .125 inch thick acrylic.
* Laser cut this file out of .25 inch thick acrylic.
* Order the hardware and electrical components listed in the bill of materials.  
    
### Assemble Electronics

![](/photos/photo15.jpg)

First, prepare the acrylic mounting plate for all of the electronics. Use a variety of standoffs to mount the electronics. The Keyestudio CNC board requires M3 screws while the raspberry pi requires M2.5 screws. Mount the dual output power supply flush to the plate with two M3 screws. Once everything is in place, the electronics can be wired. Wire the power input for the CNC GRBL board to 12 volts at output number 2. Wire the power input for the raspberry pi to 5 volts at output number 1.

![](/photos/photo16.jpg)

Next, wire the board for power and connect the Raspberry Pi to the CNC board via USB. After joining the Raspberry Pi to the CNC board, begin to populate the motor driver sockets. There is three drivers total. One driver for the x-direction, one for the y-direction, and one for the z-direction, which actuates the marker color.  
    
### Assemble the Pen Turret
The pen turret allows the machine to hold 5 markers at once, so posters can feature multiple colors. The turret assembly is mostly 3d printed but contains a few pieces of hardware. 
Before assembling the two major printed components, load each cylinder of the changer with linear bearings. Attach the pen guides with the actuating tabs matching each of the 5 slots. 

![](/photos/photo12.jpg)

Join the lower and upper assemblies with a .25" metal shaft, which runs through the two flanged bearings contained in the upper assembly. Then, place a GT2 pulley on top to provide power from the Z-axis motor. 
        
### Assemble Core XY Machine

* Cut rail to length

The gantry movement depends on the two lengths of MakerSlide, one for the x-dimension and one for the y-dimension. For the x-dimension, cut one length of MakerSlide that is 16" long. For the y- dimension, cut another piece of MakerSlide that is 22" long. The ends of each piece have two holes in the center of the rails. Tap the holes on each of these ends with an M5 tap to be able to attach the motors and pen turret.

* Assemble the center bearing hub.

![](/photos/photo4.jpg)

* The center bearing hub will move along the x-rail and hold the y-rail.  

To assemble the bearing hub, install four smooth idler pulleys on the top side of the lower plate. Next, install four V-wheels on the underside of the bottom plate so it can travel along the x-rail. Place eccentric spacers in the larger holes on the bottom plate and attach the wheels with M5 screws through the eccentric spacers. Simply insert screws into the slightly smaller holes to attach the other two wheels. Install 4 V-wheels on the top side of the upper plate for the y-rail to travel through, again using eccentric spacers for two of the wheels. Using M3 screws and 20mm M3 standoffs, connect the top and bottom plates together to complete the center bearing hub. Slide the center bearing hub onto a length of the MakerSlide to verify the preload and make adjustments by rotating the eccentric spacers.   

* Prep Rail Sub- Assemblies

![](/photos/photo6.jpg)

Tap the four small holes, which surround the large hole in the top of each motor bracket using an M5 tap. Attach a motor bracket to one side of the 16" length of MakerSlide, then slide it through the wheels on the bottom of the center bearing hub, and fasten another motor bracket to the other side.  Slip the pen turret assembly onto either end of the 22" length of MakerSlide and mark the locations for two M3 retention screws in the slots on each side. Drill a hole in each location and bore it with an M3 tap.

### Install Motors and Belt System

![](/photos/photo9.jpg)

Tap the belt clamp (m5 tap) and attach the clamp to the belt retaining plate with an m5 screw.  both the belt retaining plate and the 3rd motor bracket to the back of the 22" length of MakerSlide. Attach the x- and y-motors to their respective sides of the 16" length of MakerSlide. Route and tension the belt, referring to the core xy configuration if necessary. Tension the belt, tighten the belt clamp, and trim any excess belt. Attach the color selection motor to the 3rd motor bracket on the back of the 22" length of MakerSlide. Loosen the screws that hold the pen turret on the front of the 22" length of MakerSlide and install the closed loop belt between the pulleys on the color select motor and the pen turret. Pull the pen turret away from the color select motor to tension the belt then tighten the screws to secure the turret and belt tension.
    
### Build a Base

![](/photos/photo21.jpg)

Refer to this .dxf of the base gantry and motor pattern.
Use the pattern to create a unique base for your machine. 
Ensure that your drawing surface 1.75 inches from the bottom of the 16" inch rail. 
        
## **Firmware**
Download the latest Arduino ide.
Download the correct ch341 driver for your operating system.
Download this version of the GRBL library and import into the Arduino ide.
Connect the Keyestudio CNC GRBL board to your computer via USB
Flash the GRBL board with the GRBL library we previously downloaded.
Once the flash is complete, enter the following commands.  
Open the Arduino serial terminal and enter the following commands:
```
$22=1
$23=3
$25=1000.000
$102=640.000
$110=5000.000
$111=5000.000
$112=2000.000
$120=150.000
$121=150.000
$122=150.000
$130=70.000
$131=100.000
```
## **Software**
There are three high-level components to the Assistant Poster Makers' software system that interact to create dynamic drawing output from speech input.

The poster art is generated in a browser using [Paper.js](http://paperjs.org/), a vector graphics scripting framework. It offers complex drawing functionality such as offsets, scaling, and intersections for simple shape manipulation.

Google's Assistant SDK library for Python enables a conversational user interface for the machine. By leveraging custom device actions, we can control physical actions via pre-defined voice commands without having to leave the Google Assistant context.

A Node.js application running an Express web server acts as the "glue" for the system. Redis Pub/Sub is used as a messaging channel between the Python application and the Express server, and WebSockets are used for pushing data between that server and the frontend client. The Node.js app also uses a custom library to convert SVG (exported from Paper.js) to Gcode (runs on Grbl CNC controller).

![images/system-diagram.jpeg "System Diagram"](/photos/diagram.jpg)

1. Download and install "Raspbian Stretch with Desktop" from the Raspberry Pi [downloads page](https://www.raspberrypi.org/downloads/raspbian/)
2. Open a terminal window and clone the repository in the home (/home/pi) directory
3. Set up Redis
    * See [Redis Quick Start](https://redis.io/topics/quickstart)
    * Run Redis $ redis-server assistant-poster-node/redis.conf
4. Set up Node.js application
    * Install [Node.js](https://nodejs.org/dist/latest-v6.x/) (we used v6.14.2 LTS Boron)
    * Change directory: $ cd assistant-poster-node
    * Install dependencies: $ npm install
    * Start application: $ npm start
5. Set up Python module
    * Follow all steps in the [Embed the Google Assistant guide](https://developers.google.com/assistant/sdk/guides/library/python/embed/setup) to configure audio, create a developer project, register the device model, and run the sample code
        * Replace assistant-poster-pi/misc/credentials.json with your resulting credentials file
        * Replace PROJECT_ID with your project ID in assistant-poster-pi/misc/deploy-actions-package.sh
        * Replace ASSISTANT_DEVICE_ID with your device ID in the contructor of assistant-poster-pi/custom-assistant/_assistant_thread.py
    * Deploy action package $ cd misc; ./deploy-action-package.sh
    * Install dependencies: $ python -m pip install pymysql pyserial redis
6. Run the system
    * Start Redis server: $ redis-server redis.conf
    * Activate the virtual environment and start Python module: $ source env/bin/activate; python -um custom-assistant
    * Start Node.js module $ npm start
    * Open [frontend](http://127.0.0.1:8080) in browser
    * Speak commands to start generating poster
    * Stop with Ctrl+C
    
## **Troubleshooting**
* Ensure correct version of Grbl firmware
* Ensure the correct serial device in the run() method in assistant-poster-pi/custom-assistant/_plotter_thread.py
* [Troubleshooting the Google Assistant Library](https://developers.google.com/assistant/sdk/guides/library/troubleshooting)
